node.require("mkdirp"),node.require("jsonfile"),node.require("rimraf"),node.require("fs-extra"),node.require("archiver");var NwBuilder=node.require("node-webkit-builder"),glob=node.require("simple-glob"),ncp=node.require("ncp").ncp,AdmZip=node.require("adm-zip");_g.animate_duration_delay=320,_g.path={},_g.pathMakeObj=function(e){for(var a in e)"object"==typeof e[a]?_g.pathMakeObj(e[a]):node.mkdirp.sync(e[a])},_g.pathMakeObj(_g.path),_g.gen_title=function(e,a){return $("<"+e+' data-content="'+a+'"/>').html(a)},_g.gen_input=function(e,a,n,p,o){switch(o=o||{},e){case"text":case"number":case"hidden":var t=$('<input type="'+e+'" name="'+a+'" id="'+n+'" />').val(p);break;case"select":var t=$('<select name="'+a+'" id="'+n+'" />'),i=$('<option value=""/>').html("").appendTo(t);for(var r in p){if("object"==typeof p[r])var _=$('<option value="'+("undefined"==typeof p[r].val?p[r].value:p[r].val)+'"/>').html(p[r].title||p[r].name).appendTo(t);else var _=$('<option value="'+p[r]+'"/>').html(p[r]).appendTo(t);"undefined"!=typeof o["default"]&&_.val()==o["default"]&&_.prop("selected",!0),_.val()||_.attr("disabled",!0)}p&&p.length||(i.remove(),$('<option value=""/>').html("...").appendTo(t)),o["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(i),$('<option value="___new___"/>').html("+ 新建").insertAfter(i),t.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),o["new"](t))}));break;case"select_group":var t=$('<select name="'+a+'" id="'+n+'" />'),i=$('<option value=""/>').html("").appendTo(t);for(var r in p){var l=$('<optgroup label="'+p[r][0]+'"/>').appendTo(t);for(var c in p[r][1]){var s=p[r][1][c];if("object"==typeof s)var _=$('<option value="'+("undefined"==typeof s.val?s.value:s.val)+'"/>').html(s.title||s.name).appendTo(l);else var _=$('<option value="'+s+'"/>').html(s).appendTo(l);"undefined"!=typeof o["default"]&&_.val()==o["default"]&&_.prop("selected",!0),_.val()||_.attr("disabled",!0)}}p&&p.length||(i.remove(),$('<option value=""/>').html("...").appendTo(t)),o["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(i),$('<option value="___new___"/>').html("+ 新建").insertAfter(i),t.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),o["new"](t))}));break;case"checkbox":var t=$('<input type="'+e+'" name="'+a+'" id="'+n+'" />').prop("checked",p);break;case"checkboxes":var t=$();for(var r in p){var d=p[r];"object"!=typeof d&&(d=[d,!1]),parseInt(r)&&(_g.inputIndex++,n="_input_g"+_g.inputIndex),t=t.add($('<input type="checkbox" name="'+a+'" id="'+n+'" value="'+d[0]+'" />').prop("checked",d[1])).add($('<label for="'+n+'"/>').html(d[2]||d[0]))}break;case"directory":case"file":var m=$('<input type="file" class="none"'+("directory"==e?" nwdirectory":"")+" />").on("change",function(){t.val($(this).val()).trigger("change")}),t=$('<input type="text" name="'+a+'" id="'+n+'" />').on({input:function(){t.trigger("change")},click:function(){t.val()||f.trigger("click")}}).val(p),f=$('<button type="button" value="Browse..."/>').html("Browse...").on("click",function(){"file"==e&&m.trigger("click")}),u=t.add(m).add(f);o.accept&&m.attr("accept",o.accept)}return o.required&&t.prop("required",!0),o.onchange&&(t.on("change.___onchange___",o.onchange),o["default"]&&t.trigger("change")),a||t.attr("name",null),u?u:t},_g.gen_form_line=function(e,a,n,p,o,t){t=t||{};var i=$("<p/>").addClass(e,t.className),r="_input_g"+_g.inputIndex;switch(e){case"directory":$("<label/>").html(n).appendTo(i);break;default:o?$("<label/>").html(n).appendTo(i):$('<label for="'+r+'"/>').html(n).appendTo(i)}return _g.gen_input(e,a,r,p,t).appendTo(i),o&&$('<label for="'+r+'"/>').html(o).appendTo(i),t.add&&i.append(t.add),_g.inputIndex++,i};var builderOptions={platforms:["osx32","osx64","win32","win64"],filesRelative:["node_modules","package.json"],dataVersion:{}},packageJSON={},package_path=null,packageJSON_path=null;_g.update_options=function(e,a){a?$.extend(builderOptions,e):$.extend(!0,builderOptions,e),packageJSON_path&&_frame.app_main.option_save&&(packageJSON["nw-packager"]=builderOptions,node.jsonfile.writeFileSync(packageJSON_path,packageJSON))},_g.init_options=function(e){$.extend(!0,builderOptions,e);for(var a in builderOptions)switch(a){case"buildDir":case"launcherSplash":case"macIcns":case"winIco":_frame.app_main.fields[a].children('input[type="text"]').val(builderOptions[a]).trigger("change");break;case"enableLauncher":_frame.app_main.fields[a].children('input[type="checkbox"]').prop("checked",builderOptions[a]).trigger("change");break;case"platforms":_frame.app_main.fields[a].children('input[value="'+builderOptions[a].join('"],[value="')+'"]').prop("checked",!0).trigger("change")}},_g.relative_path=function(e){var a=node.path.relative(package_path,node.path.normalize(e));return/^[A-Za-z]\:/.test(a)||/^[\.]{2}/.test(a)?e:a},_frame.app_main={steps:[],option_save:"undefined"==typeof _config.get("option_save")?!0:"false"==_config.get("option_save")?!1:_config.get("option_save"),fields:{},step_cur:function(){return parseInt(_frame.dom.global_steps.filter(":checked").val())},step_prev:function(){_frame.app_main.step_goto(_frame.app_main.step_cur()-1)},step_next:function(){_frame.app_main.step_goto(_frame.app_main.step_cur()+1)},step_goto:function(e){var a=!0;try{a=_frame.app_main[_frame.app_main.steps[_frame.app_main.step_cur()-1]+"_submit"]()}catch(n){}if(!a)return!1;e=e||1,1>e?e=1:e>_frame.dom.global_steps.length&&(e=_frame.dom.global_steps.length);var p=_frame.dom.global_steps.filter('[value="'+e+'"]');p.prop("checked",!0).trigger("change",[p])},step_changed:function(e){1==e.val()?_frame.dom.footer_prev.addClass("disabled"):_frame.dom.footer_prev.removeClass("disabled"),e.val()==_frame.dom.global_steps.length?_frame.dom.footer_next.addClass("disabled"):_frame.dom.footer_next.removeClass("disabled");try{_frame.app_main[_frame.app_main.steps[parseInt(e.val())-1]+"_on"]()}catch(a){}},init:function(){if(_frame.app_main.is_init)return!0;_frame.dom.header=$("<header/>").appendTo(_frame.dom.layout),_frame.dom.title=$("<h1/>").html("NW-PACKAGER").appendTo(_frame.dom.header),_frame.dom.steps=$('<div class="steps"/>').appendTo(_frame.dom.header),_frame.dom.main=$("<main/>").appendTo(_frame.dom.layout),_frame.dom.main_wrapper=$('<div class="wrapper"/>').appendTo(_frame.dom.main),_frame.dom.footer=$("<footer/>").appendTo(_frame.dom.layout),_frame.dom.footer_prev=$('<button class="prev"/>').on("click",function(e){$(e.target).hasClass("disabled")||_frame.app_main.step_prev()}).html("Prev").appendTo(_frame.dom.footer),_frame.dom.footer_next=$('<button class="next"/>').on("click",function(e){$(e.target).hasClass("disabled")||_frame.app_main.step_next()}).html("Next").appendTo(_frame.dom.footer),_frame.dom.global_steps=$();for(var e in _frame.app_main.steps){var a=parseInt(e),n="global_steps_"+(a+1);_frame.dom.global_steps=_frame.dom.global_steps.add($('<input class="none" type="radio" name="global_steps" id="'+n+'" value="'+(a+1)+'"/>').prop("checked",0==e).on("change",function(e,a){a=a||$(e.target),a.prop("checked")&&_frame.app_main.step_changed(a)}).prependTo(_frame.dom.layout)),$('<span data-step="'+(a+1)+'"/>').appendTo(_frame.dom.steps);var p=$('<div data-step="'+(a+1)+'"/>').appendTo(_frame.dom.main_wrapper),o=$('<div class="wrapper"/>').appendTo(p);try{_frame.app_main[_frame.app_main.steps[e]+"_init"](o)}catch(t){}_frame.dom.debug_step_switcher&&_frame.dom.debug_step_switcher.length&&$('<label for="'+n+'"/>').html(a+1).appendTo(_frame.dom.debug_step_switcher)}_frame.app_main.step_changed(_frame.dom.global_steps.filter(":checked")),_frame.app_main.is_init=!0}},_frame.app_main.project_select_init=function(e){_g.gen_title("h2","Select directory").appendTo(e),_frame.app_main.project_select_form=$("<form/>").on("submit",function(e){_frame.app_main.project_select_submit(),e.preventDefault()}).appendTo(e),_frame.app_main.fields.project_directory=_g.gen_form_line("directory","project_directory","Project directory",null,null,{required:!0,add:$('<span class="msg"/>'),onchange:function(e){function a(){package_path=p.val(),packageJSON_path=o,_frame.app_main.fields.project_directory.removeClass("error"),_frame.app_main.fields.project_directory.children(".msg").html(""),packageJSON=node.jsonfile.readFileSync(o),_g.init_options(packageJSON["nw-packager"]||{})}function n(){package_path=null,packageJSON_path=null,packageJSON={},_frame.app_main.fields.project_directory.addClass("error"),_frame.app_main.fields.project_directory.children(".msg").html("No package.json file found. Please make sure locating a valid NW.js project directory.")}var p=$(e.target),o=node.path.join(p.val(),"/package.json");try{var t=node.fs.lstatSync(o);t&&t.isFile()?a():n()}catch(e){n()}}}).appendTo(_frame.app_main.project_select_form),_frame.app_main.fields.buildDir=_g.gen_form_line("directory","buildDir","Build output directory",null,null,{required:!0,onchange:function(e){_g.update_options({buildDir:node.path.normalize($(e.target).val())})}}).appendTo(_frame.app_main.project_select_form),_frame.app_main.fields.save_to_packagejson=_g.gen_form_line("checkbox","save_to_packagejson","Preferances",_frame.app_main.option_save,"Save to package.json file",{onchange:function(e){_frame.app_main.option_save=$(e.target).prop("checked")?!0:!1,_config.set("option_save",_frame.app_main.option_save)}}).appendTo(_frame.app_main.project_select_form)},_frame.app_main.project_select_on=function(){console.log("project_select: ON")},_frame.app_main.project_select_submit=function(){return console.log("project_select: SUBMIT"),!_frame.app_main.project_select_form.find(".error").length},_frame.app_main.nwbuild_options_init=function(e){_g.gen_title("h2","Packager options").appendTo(e),_frame.app_main.nwbuild_options_form=$("<form/>").on("submit",function(e){_frame.app_main.nwbuild_options_submit(),e.preventDefault()}).appendTo(e),_frame.app_main.fields.platforms=_g.gen_form_line("checkboxes","platforms","Platforms to build",[["win32",!0],["win64",!0],["osx32",!0],["osx64",!0],["linux32",!1],["linux64",!1]],null,{onchange:function(){var e=[];_frame.app_main.fields.platforms.children('input[name="platforms"]:checked').each(function(){e.push($(this).val())}),_g.update_options({platforms:e},!0)}}).appendTo(_frame.app_main.nwbuild_options_form),_frame.app_main.fields.macIcns=_g.gen_form_line("file","macIcns","ICNS for icon, MAC ONLY",null,null,{accept:".icns",onchange:function(e){_g.update_options({macIcns:node.path.normalize($(e.target).val())})}}).appendTo(_frame.app_main.nwbuild_options_form),_frame.app_main.fields.winIco=_g.gen_form_line("file","winIco","ICO for icon, WINDOWS ONLY",null,null,{accept:".ico",onchange:function(e){_g.update_options({winIco:node.path.normalize($(e.target).val())})}}).appendTo(_frame.app_main.nwbuild_options_form)},_frame.app_main.nwbuild_options_on=function(){console.log("nwbuild_options: ON")},_frame.app_main.nwbuild_options_submit=function(){return console.log("nwbuild_options: SUBMIT"),!0},_frame.app_main.launcher_options_init=function(e){_g.gen_title("h2","Launcher").appendTo(e),_frame.app_main.launcher_options_form=$("<form/>").on("submit",function(e){e.preventDefault()}).appendTo(e),_frame.app_main.fields.enableLauncher=_g.gen_form_line("checkbox","enableLauncher","Enable launcher",builderOptions.enableLauncher,"Enable to use launcher, which will extract Data Package to user folder when app launching. You can choose directories for Data Packages in next step.<br />Data Packages will not be compiled, but to be zipped and be placed alongside final program under DATA directory.<br />When enabled, NW-Packager will install 3 node.js modules to original project: adm-zip, jsonfile & mkdirp.",{onchange:function(e){var a=$(e.target).prop("checked");_g.update_options({enableLauncher:a}),a?_frame.app_main.files_select_table.addClass("enable_launcher"):_frame.app_main.files_select_table.removeClass("enable_launcher")}}).appendTo(_frame.app_main.launcher_options_form),_frame.app_main.fields.launcherSplash=_g.gen_form_line("file","launcherSplash","Splash image",null,null,{accept:".jpg,.jpeg,.png,.gif,.webp",onchange:function(e){_g.update_options({launcherSplash:node.path.normalize($(e.target).val())})}}).appendTo(_frame.app_main.launcher_options_form)},_frame.app_main.launcher_options_on=function(){console.log("launcher_options: ON")},_frame.app_main.launcher_options_submit=function(){return console.log("launcher_options: SUBMIT"),!0},_frame.app_main.files_select_init=function(e){_g.gen_title("h2","Files for package").appendTo(e),_frame.app_main.files_select_table=$("<table/>").appendTo(e)},_frame.app_main.files_select_on=function(){function e(e,a){var n=$("<tr/>").appendTo(_frame.app_main.files_select_table),p=new Date(o[e].mtime),t=$('<input type="checkbox" name="files" value="'+e+'"/>').on("change",function(){var e=[];_frame.app_main.files_select_checkbox_files.filter(":checked").each(function(){e.push($(this).val())}),_g.update_options({filesRelative:e},!0),t.prop("checked")&&i.prop("checked",!1).trigger("change")}).prop("checked",$.inArray(e,builderOptions.filesRelative)>-1).prop("disabled",$.inArray(e,_)>-1).appendTo($("<th/>").appendTo(n)),i=$('<input type="checkbox" name="data" value="'+e+'"/>').on("change",function(){var e=[];_frame.app_main.files_select_checkbox_data.filter(":checked").each(function(){e.push($(this).val())}),_g.update_options({dataRelative:e},!0),i.prop("checked")?(t.prop("checked",!1).trigger("change"),n.addClass("isdatapackage")):n.removeClass("isdatapackage")}).prop("checked",$.inArray(e,builderOptions.dataRelative)>-1).prop("disabled","file"==a).appendTo($('<th class="datapackage"/>').appendTo(n));i.prop("checked")&&n.addClass("isdatapackage"),_frame.app_main.files_select_checkbox_files=_frame.app_main.files_select_checkbox_files.add(t),_frame.app_main.files_select_checkbox_data=_frame.app_main.files_select_checkbox_data.add(i),$("<td/>").html('<span icon="'+a+'">'+e+"</span>").append($("<div/>").append($('<input type="text" placeholder="Version"/>').on("change",function(a){var n={};n[e]=$(a.target).val(),_g.update_options({dataVersion:n})}).val(builderOptions.dataVersion[e]||""))).appendTo(n),$("<td/>").html(p.toLocaleString()).appendTo(n)}if(console.log("data_select: ON"),_frame.app_main.files_select_table.html('<thead><tr><th>Compile</th><th class="datapackage">Data</th><th></th><th>Last Modified</th></tr><thead>'),_frame.app_main.files_select_folders=[],!package_path)return!1;var a=node.fs.readdirSync(package_path),n=[],p=[],o={};_frame.app_main.files_select_checkbox_files=$(),_frame.app_main.files_select_checkbox_data=$();for(var t in a)try{var i=node.fs.lstatSync(node.path.join(package_path,a[t]));i&&(o[a[t]]=i,i.isDirectory()?n.push(a[t]):i.isFile()&&p.push(a[t]))}catch(r){}n.sort(),p.sort();var _=["node_modules","package.json"];for(var t in n)e(n[t],"folder");for(var t in p)e(p[t],"file");_frame.app_main.files_select_folders=n},_frame.app_main.files_select_submit=function(){return console.log("data_select: SUBMIT"),!0},_frame.app_main.processing_running=!1,_frame.app_main.processing_init=function(e){_g.gen_title("h2","Packaging...").appendTo(e),_frame.app_main.processing_dombody=e.parent(),_frame.app_main.processing_domwrapper=e,_frame.app_main.processing_domlog=$('<div class="log"/>').appendTo(e)},_frame.app_main.processing_on=function(){function e(e){function a(e){node.fs.renameSync(node.path.join(package_path,"package.json"),node.path.join(package_path,"package-app.json")),_frame.app_main.processing_log("package.json renamed to package-app.json."),builderOptions.launcherSplash?ncp(builderOptions.launcherSplash,node.path.join(package_path,"/____launcher____"),function(a){return a?console.error(a):(_frame.app_main.processing_log("launcher splash image copied."),void e())}):e()}function n(e){_frame.app_main.processing_log("copying launcher related files..."),ncp(node.path.join(_g.root,"/app/launcher"),node.path.join(package_path),function(a){return a?console.error(a):(_frame.app_main.processing_log("launcher related files copied."),new_packageJSON=node.jsonfile.readFileSync(node.path.join(package_path,"/package.json")),new_packageJSON.name=packageJSON.name,new_packageJSON.version=packageJSON.version,node.jsonfile.writeFileSync(node.path.join(package_path,"/package.json"),new_packageJSON),void e())})}function p(e){function a(e){var a=new node.archiver("zip",{comment:builderOptions.dataVersion[e]}),p=node.path.join(t,e+".nwjs-data"),r=node.fs.createWriteStream(p).on("finish",function(){_frame.app_main.processing_log(e+".nwjs-data generated."),i++,n()});a.directory(node.path.join(package_path,"/"+e),e),a.pipe(r),a.finalize(),o.push(p)}function n(){!r&&i>=p.length&&(r=!0,_frame.app_main.processing_log("all data (.nwjs-data) files generated."),e())}var p=builderOptions.dataRelative||[],i=0,r=!1;t=node.path.join(node.gui.App.dataPath,"/___zip___"),node.mkdirp.sync(t);for(var _ in p)a(p[_])}builderOptions.enableLauncher?a(function(){n(function(){p(e)})}):e()}function a(){$.extend(i,builderOptions),i.files=[];for(var e in i.filesRelative)i.files.push(node.path.join(package_path,"/"+i.filesRelative[e]).replace(/\\/g,"/")+($.inArray(i.filesRelative[e],_frame.app_main.files_select_folders)>-1?"/**":""));builderOptions.enableLauncher&&(i.files.push(node.path.join(package_path,"/____launcher____.html").replace(/\\/g,"/")),i.files.push(node.path.join(package_path,"/package-app.json").replace(/\\/g,"/")),builderOptions.launcherSplash&&i.files.push(node.path.join(package_path,"/____launcher____").replace(/\\/g,"/")));for(var e in i)switch(e){case"buildDir":case"macIcns":case"winIco":i[e]=i[e].replace(/\\/g,"/")}delete i.enableLauncher,delete i.launcherSplash,delete i.filesRelative,delete i.dataRelative,delete i.dataVersion,console.log(i),n()}function n(){var e=node.path.join(builderOptions.buildDir,packageJSON.name);node["fs-extra"].emptyDirSync(e),_frame.app_main.processing_log("target directory ready.");var a=new NwBuilder(i);a.on("log",_frame.app_main.processing_log),a.build().then(function(){_frame.app_main.processing_log("builder done!"),p()}).catch(function(e){console.error(e)})}function p(){if(builderOptions.enableLauncher){if(node.fs.unlinkSync(node.path.join(package_path,"____launcher____")),node.fs.unlinkSync(node.path.join(package_path,"____launcher____.html")),node.fs.unlinkSync(node.path.join(package_path,"package.json")),_frame.app_main.processing_log("launcher related files deleted."),o.length)for(var e in i.platforms){var a=i.platforms[e];switch(a){case"osx32":case"osx64":node["fs-extra"].copySync(t,node.path.join(builderOptions.buildDir,packageJSON.name,a,packageJSON.name+".app","Contents/Resources/app.nw","data"));break;default:node["fs-extra"].copySync(t,node.path.join(builderOptions.buildDir,packageJSON.name,a,"data"))}_frame.app_main.processing_log("data files copied for "+a+".")}node.fs.renameSync(node.path.join(package_path,"package-app.json"),node.path.join(package_path,"package.json")),_frame.app_main.processing_log("package-app.json renamed to package.json.")}_frame.app_main.processing_log("all process completed!"),_frame.app_main.processing_running=!1}if(console.log("processing: ON"),!package_path||_frame.app_main.processing_running)return!1;_frame.app_main.processing_running=!0;var o=[],t=null,i={};e(a)},_frame.app_main.processing_log=function(e){console.log(e);var a=(new Date,_frame.app_main.processing_domlog.children("p"));a.length>100&&a.eq(0).remove(),_frame.app_main.processing_domlog.append($("<p/>").html("<em>"+_g.formatTime(new Date,"%H:%i:%s")+"</em><span>"+e+"</span>")),_frame.app_main.processing_dombody.scrollTop(_frame.app_main.processing_domwrapper[0].clientHeight)};