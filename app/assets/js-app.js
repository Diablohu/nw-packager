node.require("mkdirp"),node.require("jsonfile"),node.require("rimraf"),node.require("fs-extra"),node.require("archiver"),node.require("request"),node.require("semver");var NwBuilder=node.require("node-webkit-builder"),glob=node.require("simple-glob"),Q=node.require("Q");_g.animate_duration_delay=320,_g.path={},_g.pathMakeObj=function(e){for(var a in e)"object"==typeof e[a]?_g.pathMakeObj(e[a]):node.mkdirp.sync(e[a])},_g.pathMakeObj(_g.path),_g.gen_title=function(e,a){return $("<"+e+' data-content="'+a+'"/>').html(a)},_g.gen_input=function(e,a,n,o,p){switch(p=p||{},e){case"text":case"number":case"hidden":var i=$('<input type="'+e+'" name="'+a+'" id="'+n+'" />').val(o);break;case"select":var i=$('<select name="'+a+'" id="'+n+'" />'),r=$('<option value=""/>').html("").appendTo(i);for(var t in o){if("object"==typeof o[t])var _=$('<option value="'+("undefined"==typeof o[t].val?o[t].value:o[t].val)+'"/>').html(o[t].title||o[t].name).appendTo(i);else var _=$('<option value="'+o[t]+'"/>').html(o[t]).appendTo(i);"undefined"!=typeof p["default"]&&_.val()==p["default"]&&_.prop("selected",!0),_.val()||_.attr("disabled",!0)}o&&o.length||(r.remove(),$('<option value=""/>').html("...").appendTo(i)),p["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),i.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),p["new"](i))}));break;case"select_group":var i=$('<select name="'+a+'" id="'+n+'" />'),r=$('<option value=""/>').html("").appendTo(i);for(var t in o){var l=$('<optgroup label="'+o[t][0]+'"/>').appendTo(i);for(var s in o[t][1]){var c=o[t][1][s];if("object"==typeof c)var _=$('<option value="'+("undefined"==typeof c.val?c.value:c.val)+'"/>').html(c.title||c.name).appendTo(l);else var _=$('<option value="'+c+'"/>').html(c).appendTo(l);"undefined"!=typeof p["default"]&&_.val()==p["default"]&&_.prop("selected",!0),_.val()||_.attr("disabled",!0)}}o&&o.length||(r.remove(),$('<option value=""/>').html("...").appendTo(i)),p["new"]&&($('<option value="" disabled/>').html("==========").insertAfter(r),$('<option value="___new___"/>').html("+ 新建").insertAfter(r),i.on("change.___new___",function(){var e=$(this);"___new___"==e.val()&&(e.val(""),p["new"](i))}));break;case"checkbox":var i=$('<input type="'+e+'" name="'+a+'" id="'+n+'" />').prop("checked",o);break;case"checkboxes":var i=$();for(var t in o){var d=o[t];"object"!=typeof d&&(d=[d,!1]),parseInt(t)&&(_g.inputIndex++,n="_input_g"+_g.inputIndex),i=i.add($('<input type="checkbox" name="'+a+'" id="'+n+'" value="'+d[0]+'" />').prop("checked",d[1])).add($('<label for="'+n+'"/>').html(d[2]||d[0]))}break;case"directory":case"file":var m=$('<input type="file" class="none"'+("directory"==e?" nwdirectory":"")+" />").on("change",function(){i.val($(this).val()).trigger("change")}),i=$('<input type="text" name="'+a+'" id="'+n+'" />').on({input:function(){i.trigger("change")},click:function(){i.val()||f.trigger("click")}}).val(o),f=$('<button type="button" value="Browse..."/>').html("Browse...").on("click",function(){m.trigger("click")}),u=i.add(m).add(f);p.accept&&m.attr("accept",p.accept)}return p.required&&i.prop("required",!0),p.onchange&&(i.on("change.___onchange___",p.onchange),p["default"]&&i.trigger("change")),a||i.attr("name",null),u?u:i},_g.gen_form_line=function(e,a,n,o,p,i){i=i||{};var r=$("<p/>").addClass(e,i.className),t="_input_g"+_g.inputIndex;switch(e){case"directory":$("<label/>").html(n).appendTo(r);break;default:p?$("<label/>").html(n).appendTo(r):$('<label for="'+t+'"/>').html(n).appendTo(r)}return _g.gen_input(e,a,t,o,i).appendTo(r),p&&$('<label for="'+t+'"/>').html(p).appendTo(r),i.add&&r.append(i.add),_g.inputIndex++,r};var builderOptions={version:"latest",platforms:["osx32","osx64","win32","win64"],filesRelative:["node_modules","package.json"],dataVersion:{}},packageJSON={},package_path=null,packageJSON_path=null;_g.update_options=function(e,a){a?$.extend(builderOptions,e):$.extend(!0,builderOptions,e),packageJSON_path&&_frame.app_main.option_save&&(packageJSON["nw-packager"]=builderOptions,node.jsonfile.writeFileSync(packageJSON_path,packageJSON))},_g.init_options=function(e){$.extend(!0,builderOptions,e);for(var a in builderOptions)switch(a){case"enableLauncher":_frame.app_main.fields[a].children('input[type="checkbox"]').prop("checked",builderOptions[a]).trigger("change");break;case"platforms":_frame.app_main.fields[a].children('input[value="'+builderOptions[a].join('"],[value="')+'"]').prop("checked",!0).trigger("change");break;default:_frame.app_main.fields[a]&&_frame.app_main.fields[a].children&&_frame.app_main.fields[a].children('input[type="text"],select').val(builderOptions[a]).trigger("change")}packageJSON.window.icon&&_frame.app_main.fields.menifest_window_icon.children('input[type="text"]').val(packageJSON.window.icon)},_g.relative_path=function(e){var a=node.path.relative(package_path,node.path.normalize(e));return/^[A-Za-z]\:/.test(a)||/^[\.]{2}/.test(a)?e:a},_frame.app_main={steps:[],option_save:"undefined"==typeof _config.get("option_save")?!0:"false"==_config.get("option_save")?!1:_config.get("option_save"),fields:{},step_cur:function(){return parseInt(_frame.dom.global_steps.filter(":checked").val())},step_prev:function(){_frame.app_main.step_goto(_frame.app_main.step_cur()-1)},step_next:function(){_frame.app_main.step_goto(_frame.app_main.step_cur()+1)},step_goto:function(e){var a=!0;try{a=_frame.app_main[_frame.app_main.steps[_frame.app_main.step_cur()-1]+"_submit"]()}catch(n){}if(!a)return!1;e=e||1,1>e?e=1:e>_frame.dom.global_steps.length&&(e=_frame.dom.global_steps.length);var o=_frame.dom.global_steps.filter('[value="'+e+'"]');o.prop("checked",!0).trigger("change",[o])},step_changed:function(e){1==e.val()?_frame.dom.footer_prev.addClass("disabled"):_frame.dom.footer_prev.removeClass("disabled"),e.val()==_frame.dom.global_steps.length?_frame.dom.footer_next.addClass("disabled"):_frame.dom.footer_next.removeClass("disabled");try{_frame.app_main[_frame.app_main.steps[parseInt(e.val())-1]+"_on"]()}catch(a){}},init:function(){if(_frame.app_main.is_init)return!0;_frame.dom.header=$("<header/>").appendTo(_frame.dom.layout),_frame.dom.title=$("<h1/>").html("NW-PACKAGER").appendTo(_frame.dom.header),_frame.dom.steps=$('<div class="steps"/>').appendTo(_frame.dom.header),_frame.dom.main=$("<main/>").appendTo(_frame.dom.layout),_frame.dom.main_wrapper=$('<div class="wrapper"/>').appendTo(_frame.dom.main),_frame.dom.footer=$("<footer/>").appendTo(_frame.dom.layout),_frame.dom.footer_prev=$('<button class="prev"/>').on("click",function(e){$(e.target).hasClass("disabled")||_frame.app_main.step_prev()}).html("Prev").appendTo(_frame.dom.footer),_frame.dom.footer_next=$('<button class="next"/>').on("click",function(e){$(e.target).hasClass("disabled")||_frame.app_main.step_next()}).html("Next").appendTo(_frame.dom.footer),_frame.dom.global_steps=$();for(var e in _frame.app_main.steps){var a=parseInt(e),n="global_steps_"+(a+1);_frame.dom.global_steps=_frame.dom.global_steps.add($('<input class="none" type="radio" name="global_steps" id="'+n+'" value="'+(a+1)+'"/>').prop("checked",0==e).on("change",function(e,a){a=a||$(e.target),a.prop("checked")&&_frame.app_main.step_changed(a)}).prependTo(_frame.dom.layout)),$('<span data-step="'+(a+1)+'"/>').appendTo(_frame.dom.steps);var o=$('<div data-step="'+(a+1)+'"/>').appendTo(_frame.dom.main_wrapper),p=$('<div class="wrapper"/>').appendTo(o);try{_frame.app_main[_frame.app_main.steps[e]+"_init"](p)}catch(i){}_frame.dom.debug_step_switcher&&_frame.dom.debug_step_switcher.length&&$('<label for="'+n+'"/>').html(a+1).appendTo(_frame.dom.debug_step_switcher)}_frame.app_main.step_changed(_frame.dom.global_steps.filter(":checked")),_frame.app_main.is_init=!0}},_frame.app_main.project_select_init=function(e){_g.gen_title("h2","Select directory").appendTo(e),_frame.app_main.project_select_form=$("<form/>").on("submit",function(e){_frame.app_main.project_select_submit(),e.preventDefault()}).appendTo(e),_frame.app_main.fields.project_directory=_g.gen_form_line("directory","project_directory","Project directory",null,null,{required:!0,add:$('<span class="msg"/>'),onchange:function(e){function a(){package_path=o.val(),packageJSON_path=p,_frame.app_main.fields.project_directory.removeClass("error"),_frame.app_main.fields.project_directory.children(".msg").html(""),packageJSON=node.jsonfile.readFileSync(p),_g.init_options(packageJSON["nw-packager"]||{})}function n(){package_path=null,packageJSON_path=null,packageJSON={},_frame.app_main.fields.project_directory.addClass("error"),_frame.app_main.fields.project_directory.children(".msg").html("No package.json file found. Please make sure locating a valid NW.js project directory.")}var o=$(e.target),p=node.path.join(o.val(),"/package.json");try{var i=node.fs.lstatSync(p);i&&i.isFile()?a():n()}catch(e){n()}}}).appendTo(_frame.app_main.project_select_form),_frame.app_main.fields.buildDir=_g.gen_form_line("directory","buildDir","Build output directory",null,null,{required:!0,onchange:function(e){_g.update_options({buildDir:node.path.normalize($(e.target).val())})}}).appendTo(_frame.app_main.project_select_form),_frame.app_main.fields.save_to_packagejson=_g.gen_form_line("checkbox","save_to_packagejson","Preferances",_frame.app_main.option_save,"Save to package.json file",{onchange:function(e){_frame.app_main.option_save=$(e.target).prop("checked")?!0:!1,_config.set("option_save",_frame.app_main.option_save)}}).appendTo(_frame.app_main.project_select_form)},_frame.app_main.project_select_on=function(){console.log("project_select: ON")},_frame.app_main.project_select_submit=function(){return console.log("project_select: SUBMIT"),!_frame.app_main.project_select_form.find(".error").length},_frame.app_main.nwbuild_options_init=function(e){_frame.app_main.nwbuild_options_form=$("<form/>").on("submit",function(e){_frame.app_main.nwbuild_options_submit(),e.preventDefault()}).appendTo(e),_g.gen_title("h2","Menifest window object").appendTo(_frame.app_main.nwbuild_options_form),_frame.app_main.fields.menifest_window_icon=_g.gen_form_line("file","menifest_window_icon","PNG for icon, WINDOWS ONLY",null,null,{accept:".png",onchange:function(e){var a=$(e.target),n=_g.relative_path(a.val());a.val(n),packageJSON.window.icon=n,node.jsonfile.writeFileSync(packageJSON_path,packageJSON)}}).appendTo(_frame.app_main.nwbuild_options_form),_g.gen_title("h2","NwBuilder options").appendTo(_frame.app_main.nwbuild_options_form),_frame.app_main.fields.version=_g.gen_form_line("select","version","NW.js version to build",["latest","0.12.0"],null,{"default":"latest",onchange:function(e){_g.update_options({version:$(e.target).val()})}}).appendTo(_frame.app_main.nwbuild_options_form);var a,n=/href="v?([0-9]+\.[0-9]+\.[0-9]+[^"]*)\/"/gi,o=[];node.request("http://dl.nwjs.io/",function(e,p,i){if(!e&&200==p.statusCode){for(;null!==(a=n.exec(i));)a=a[1],node.semver.valid(a)&&$.inArray(a,o)<0&&o.push(a);o=o.sort(function(e,a){return node.semver.compare(a,e)})}var r=_frame.app_main.fields.version.children("select");o.splice(0,0,"latest"),o.length&&r.empty();for(var t in o)$('<option value="'+o[t]+'"/>').html(o[t]).appendTo(r)}),_frame.app_main.fields.platforms=_g.gen_form_line("checkboxes","platforms","Platforms to build",[["win32",!0],["win64",!0],["osx32",!0],["osx64",!0],["linux32",!1],["linux64",!1]],null,{onchange:function(){var e=[];_frame.app_main.fields.platforms.children('input[name="platforms"]:checked').each(function(){e.push($(this).val())}),_g.update_options({platforms:e},!0)}}).appendTo(_frame.app_main.nwbuild_options_form),_frame.app_main.fields.macIcns=_g.gen_form_line("file","macIcns","ICNS for icon, MAC ONLY",null,null,{accept:".icns",onchange:function(e){_g.update_options({macIcns:node.path.normalize($(e.target).val())})}}).appendTo(_frame.app_main.nwbuild_options_form),_frame.app_main.fields.winIco=_g.gen_form_line("file","winIco","ICO for icon, WINDOWS ONLY",null,null,{accept:".ico",onchange:function(e){_g.update_options({winIco:node.path.normalize($(e.target).val())})}}).appendTo(_frame.app_main.nwbuild_options_form)},_frame.app_main.nwbuild_options_on=function(){console.log("nwbuild_options: ON")},_frame.app_main.nwbuild_options_submit=function(){return console.log("nwbuild_options: SUBMIT"),!0},_frame.app_main.launcher_splash_size={width:0,height:0},_frame.app_main.launcher_options_init=function(e){_g.gen_title("h2","Launcher").appendTo(e),_frame.app_main.launcher_options_form=$('<form class="launcher_options"/>').on("submit",function(e){e.preventDefault()}).appendTo(e),_frame.app_main.fields.enableLauncher=_g.gen_form_line("checkbox","enableLauncher","Enable launcher",builderOptions.enableLauncher,"Enable to use launcher, which will extract Data Package to user folder when app launching. You can choose directories for Data Packages in next step.<br />Data Packages will not be compiled, but to be zipped and be placed alongside final program under DATA directory.<br /><br />When enabled, NW-Packager will install following node.js modules to original project:<br /><em>adm-zip</em>, <em>jsonfile</em>, <em>mkdirp</em>, <em>q</em>",{onchange:function(e){var a=$(e.target).prop("checked");_g.update_options({enableLauncher:a}),a?_frame.app_main.files_select_table.addClass("enable_launcher"):_frame.app_main.files_select_table.removeClass("enable_launcher")}}).appendTo(_frame.app_main.launcher_options_form),_frame.app_main.fields.launcherSplash=_g.gen_form_line("file","launcherSplash","Splash image",null,null,{accept:".jpg,.jpeg,.png,.gif,.webp,.bmp,.tiff",onchange:function(e){var a=$(e.target).val();_g.update_options({launcherSplash:node.path.normalize(a)}),_frame.app_main.launcher_options_splashimg.attr("src",a)}}).appendTo(_frame.app_main.launcher_options_form),_frame.app_main.launcher_options_splashimg=$("<img/>").on("load",function(e){_frame.app_main.launcher_options_splashimg.attr("src")&&(_frame.app_main.launcher_splash_size={width:e.target.naturalWidth,height:e.target.naturalHeight})}).appendTo(_frame.app_main.launcher_options_form)},_frame.app_main.launcher_options_on=function(){console.log("launcher_options: ON")},_frame.app_main.launcher_options_submit=function(){return console.log("launcher_options: SUBMIT"),!0},_frame.app_main.files_select_init=function(e){_g.gen_title("h2","Files for package").appendTo(e),_frame.app_main.files_select_table=$("<table/>").appendTo(e)},_frame.app_main.files_select_on=function(){function e(e,a){var n=$("<tr/>").appendTo(_frame.app_main.files_select_table),o=new Date(p[e].mtime),i=$('<input type="checkbox" name="files" value="'+e+'"/>').on("change",function(){var e=[];_frame.app_main.files_select_checkbox_files.filter(":checked").each(function(){e.push($(this).val())}),_g.update_options({filesRelative:e},!0),i.prop("checked")&&r.prop("checked",!1).trigger("change")}).prop("checked",$.inArray(e,builderOptions.filesRelative)>-1).prop("disabled",$.inArray(e,_)>-1).appendTo($("<th/>").appendTo(n)),r=$('<input type="checkbox" name="data" value="'+e+'"/>').on("change",function(){var e=[];_frame.app_main.files_select_checkbox_data.filter(":checked").each(function(){e.push($(this).val())}),_g.update_options({dataRelative:e},!0),r.prop("checked")?(i.prop("checked",!1).trigger("change"),n.addClass("isdatapackage")):n.removeClass("isdatapackage")}).prop("checked",$.inArray(e,builderOptions.dataRelative)>-1).prop("disabled","file"==a).appendTo($('<th class="datapackage"/>').appendTo(n));r.prop("checked")&&n.addClass("isdatapackage"),_frame.app_main.files_select_checkbox_files=_frame.app_main.files_select_checkbox_files.add(i),_frame.app_main.files_select_checkbox_data=_frame.app_main.files_select_checkbox_data.add(r),$("<td/>").html('<span icon="'+a+'">'+e+"</span>").append($("<div/>").append($('<input type="text" placeholder="Version"/>').on("change",function(a){var n={};n[e]=$(a.target).val(),_g.update_options({dataVersion:n})}).val(builderOptions.dataVersion[e]||""))).appendTo(n),$('<td class="time"/>').html(o.toLocaleString()).appendTo(n)}if(console.log("data_select: ON"),_frame.app_main.files_select_table.html('<thead><tr><th>Compile</th><th class="datapackage">Data</th><th></th><th>Last Modified</th></tr><thead>'),_frame.app_main.files_select_folders=[],!package_path)return!1;var a=node.fs.readdirSync(package_path),n=[],o=[],p={};_frame.app_main.files_select_checkbox_files=$(),_frame.app_main.files_select_checkbox_data=$();for(var i in a)try{var r=node.fs.lstatSync(node.path.join(package_path,a[i]));r&&(p[a[i]]=r,r.isDirectory()?n.push(a[i]):r.isFile()&&o.push(a[i]))}catch(t){}n.sort(),o.sort();var _=["node_modules","package.json"];for(var i in n)e(n[i],"folder");for(var i in o)e(o[i],"file");_frame.app_main.files_select_folders=n},_frame.app_main.files_select_submit=function(){return console.log("data_select: SUBMIT"),!0},_frame.app_main.processing_running=!1,_frame.app_main.processing_launcher_files=!1,_frame.app_main.processing_init=function(e){_g.gen_title("h2","Packaging...").appendTo(e),_frame.app_main.processing_dombody=e.parent(),_frame.app_main.processing_domwrapper=e,_frame.app_main.processing_domlog=$('<div class="log"/>').appendTo(e)},_frame.app_main.processing_on=function(){function e(){function e(){var e=Q.defer();return _frame.app_main.processing_launcher_files=!0,node.fs.renameSync(node.path.join(package_path,"package.json"),node.path.join(package_path,"package-app.json")),_frame.app_main.processing_log("package.json renamed to package-app.json."),builderOptions.launcherSplash&&node["fs-extra"].copy(builderOptions.launcherSplash,node.path.join(package_path,"/____launcher____"),function(a){return a?console.error(a):(_frame.app_main.processing_log("launcher splash image copied."),void e.resolve(a))}),e.promise}function a(){var e=Q.defer();return _frame.app_main.processing_log("copying launcher related files..."),node["fs-extra"].copy(node.path.join(_g.root,"/app/launcher"),package_path,function(a){if(a)return console.error(a);if(_frame.app_main.processing_log("launcher related files copied."),new_packageJSON=node.jsonfile.readFileSync(node.path.join(package_path,"/package.json")),new_packageJSON.name=packageJSON.name,new_packageJSON.version=packageJSON.version,new_packageJSON.window.icon=packageJSON.window.icon,_frame.app_main.launcher_splash_size.width&&_frame.app_main.launcher_splash_size.height){var n=parseInt(new_packageJSON.window.width),o=parseInt(new_packageJSON.window.height);_frame.app_main.launcher_splash_size.width>=_frame.app_main.launcher_splash_size.height?new_packageJSON.window.height=Math.floor(n*_frame.app_main.launcher_splash_size.height/_frame.app_main.launcher_splash_size.width):new_packageJSON.window.width=Math.floor(o*_frame.app_main.launcher_splash_size.width/_frame.app_main.launcher_splash_size.height)}node.jsonfile.writeFileSync(node.path.join(package_path,"/package.json"),new_packageJSON),e.resolve(a)}),e.promise}function n(){var e=Q.defer(),a=node.path.join(package_path,"____launcher____.html");return node.fs.readFile(a,"utf8",function(n,o){if(n)return e.reject(new Error(error)),console.log(n);var p=o.replace("<title>____TITLE____</title>","<title>"+packageJSON.name+"</title>");node.fs.writeFile(a,p,"utf8",function(a){return a?(e.reject(new Error(error)),console.log(a)):void e.resolve()})}),e.promise}function o(){return node["fs-extra"].mkdirp(t)}function p(){var e=[];return builderOptions.dataRelative.forEach(function(a){var n=Q.defer(),o=new node.archiver("zip",{comment:builderOptions.dataVersion[a]}),p=node.path.join(t,a+".nwjs-data"),i=node.fs.createWriteStream(p).on("finish",function(e){_frame.app_main.processing_log(a+".nwjs-data generated."),n.resolve(e)});o.directory(node.path.join(package_path,"/"+a),a),o.pipe(i),o.finalize(),r.push(p),e.push(n.promise)}),Q.all(e)}var i=Q.fcall(function(){});return builderOptions.enableLauncher?i.then(e).then(a).then(n).then(o).then(p).then(function(){return _frame.app_main.processing_log("launcher fin."),i.done()}):i.fin()}function a(){$.extend(_,builderOptions),_.files=[];for(var e in _.filesRelative)_.files.push(node.path.join(package_path,"/"+_.filesRelative[e]).replace(/\\/g,"/")+($.inArray(_.filesRelative[e],_frame.app_main.files_select_folders)>-1?"/**":""));builderOptions.enableLauncher&&(_.files.push(node.path.join(package_path,"/____launcher____.html").replace(/\\/g,"/")),_.files.push(node.path.join(package_path,"/package-app.json").replace(/\\/g,"/")),builderOptions.launcherSplash&&_.files.push(node.path.join(package_path,"/____launcher____").replace(/\\/g,"/")));for(var e in _)switch(e){case"buildDir":case"macIcns":case"winIco":_[e]=_[e].replace(/\\/g,"/")}return delete _.enableLauncher,delete _.launcherSplash,delete _.filesRelative,delete _.dataRelative,delete _.dataVersion,console.log(_),Q()}function n(){var e=node.path.join(builderOptions.buildDir,packageJSON.name),a=Q.defer();node["fs-extra"].emptyDirSync(e),_frame.app_main.processing_log("NwBuilder target directory ready."),_frame.app_main.processing_log("NwBuilder building...");var n=new NwBuilder(_);return n.on("log",console.log),n.build().then(function(){_frame.app_main.processing_log("builder done!"),a.resolve()}).catch(function(e){console.error(e),a.reject(new Error(e))}),a.promise}function o(){if(_frame.app_main.processing_launcher_files){var e=[],a=["____launcher____","____launcher____.html","package.json"];return a.forEach(function(a){var n=Q.defer();node["fs-extra"].remove(node.path.join(package_path,a),function(e){n.resolve(e)}),e.push(n.promise)}),Q.all(e)}return Q()}function p(){if(_frame.app_main.processing_launcher_files){var e=Q.defer();return node.fs.rename(node.path.join(package_path,"package-app.json"),node.path.join(package_path,"package.json"),function(a){e.resolve(a),_frame.app_main.processing_launcher_files=!1,_frame.app_main.processing_log("package-app.json renamed back to package.json.")}),e.promise}return Q()}function i(){var e=Q.fcall(function(){});return builderOptions.enableLauncher&&(e=e.then(o).then(function(){var e=Q.defer();return _frame.app_main.processing_log("launcher related files deleted."),e.resolve(),e.promise}).then(function(){if(r.length){var e=[];return _.platforms.forEach(function(a){var n=Q.defer(),o=node.path.join(builderOptions.buildDir,packageJSON.name,a,"data");switch(a){case"osx32":case"osx64":o=node.path.join(builderOptions.buildDir,packageJSON.name,a,packageJSON.name+".app","Contents/Resources/app.nw","data")}node["fs-extra"].copy(t,o,function(e){n.resolve(e),_frame.app_main.processing_log("data files copied for "+a+".")}),e.push(n.promise)}),Q.all(e)}return Q()}).then(function(){return node["fs-extra"].remove(t)}).then(p)),e.then(function(){return _frame.app_main.processing_log("All process completed!","complete"),_frame.app_main.processing_running=!1,e.done()})}if(console.log("processing: ON"),!package_path||_frame.app_main.processing_running)return!1;_frame.app_main.processing_running=!0;var r=[],t=node.path.join(node.gui.App.dataPath,"/___zip___"),_={},l=Q.fcall(function(){});l.then(e).then(a).then(n).then(i).catch(function(e){console.log(e);Q.fcall(function(){}).then(o).then(p)})},_frame.app_main.processing_log=function(e,a){console.log(e);var n=(new Date,_frame.app_main.processing_domlog.children("p"));n.length>100&&n.eq(0).remove(),_frame.app_main.processing_domlog.append($("<p/>").html("<em>"+_g.formatTime(new Date,"%H:%i:%s")+"</em><span>"+e+"</span>").addClass(a)),_frame.app_main.processing_dombody.scrollTop(_frame.app_main.processing_domwrapper[0].clientHeight)};